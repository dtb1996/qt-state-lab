name: Release (Linux + Windows)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write   # required to create GitHub Releases

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List available Qt modules (Linux)
        run: |
          python3 -m pip install aqtinstall
          python3 -m aqt list-qt linux desktop
          python3 -m aqt list-qt linux desktop --arch 6.10.1
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.10.1
          arch: gcc_64
          cache: true
          modules: qtbase qtdeclarative

      - name: Configure
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}/.."

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Package Linux binary
        run: |
          mkdir -p dist/linux
          cp build/appQtStateLab dist/linux/

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: QtStateLab-linux
          path: dist/linux


  build-windows:
    name: Build Windows
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List available Qt modules (Windows)
        run: |
          python -m pip install aqtinstall
          python -m aqt list-qt linux desktop
          python -m aqt list-qt windows desktop --modules 6.10.1 win64_msvc2022_64

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.10.1
          arch: win64_msvc2022_64
          cache: true
          modules: qtbase qtdeclarative

      - name: Configure
        run: |
          cmake -S . -B build ^
            -G "Visual Studio 17 2022" ^
            -A x64 ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}/._

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Deploy Qt (windeployqt)
        run: |
          mkdir dist\windows
          "${{ env.Qt6_DIR }}\bin\windeployqt.exe" --dir dist\windows build\Release\appQtStateLab.exe

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: QtStateLab-windows
          path: dist/windows

  release:
    name: Publish GitHub Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-22.04

    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: QtStateLab-linux
          path: release/linux

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: QtStateLab-windows
          path: release/windows

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/linux/*
            release/windows/*
